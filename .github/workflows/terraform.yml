name: Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to plan/apply'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: us-east-1
  TF_WORKING_DIR: infra/terraform
  # Default to dev for push/PR, use input for manual dispatch
  TF_ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

concurrency:
  group: terraform-${{ github.event.inputs.environment || 'dev' }}-${{ github.event.pull_request.number || 'main' }}
  cancel-in-progress: false

jobs:
  plan:
    name: Terraform Plan (${{ github.event.inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}

    env:
      TF_VAR_anthropic_api_key: ${{ secrets.TF_VAR_ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14"

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Select Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform workspace select ${{ env.TF_ENVIRONMENT }} || terraform workspace new ${{ env.TF_ENVIRONMENT }}

      - name: Terraform Format Check
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        shell: bash
        run: |
          set +o pipefail  # Allow pipeline to continue even if terraform exits non-zero
          set +e  # Disable errexit to allow capturing non-zero exit codes
          terraform plan \
            -var-file=environments/shared.tfvars \
            -var-file=environments/${{ env.TF_ENVIRONMENT }}.tfvars \
            -detailed-exitcode \
            -out=tfplan \
            -no-color 2>&1 | tee plan_output.txt; EXIT_CODE="${PIPESTATUS[0]}"
          set -e  # Re-enable errexit

          echo "Terraform plan exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          elif [ "$EXIT_CODE" -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "Terraform plan failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Post Plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan_output.txt', 'utf8');
            const hasChanges = '${{ steps.plan.outputs.has_changes }}' === 'true';
            const env = '${{ env.TF_ENVIRONMENT }}';

            const truncatedPlan = plan.length > 60000
              ? plan.substring(0, 60000) + '\n\n... (truncated)'
              : plan;

            const body = `## Terraform Plan (${env}) ${hasChanges ? '⚠️ Changes Detected' : '✅ No Changes'}

            <details>
            <summary>Show Plan</summary>

            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`

            </details>

            ${hasChanges ? '**This PR will modify infrastructure. Review carefully.**' : ''}
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(`## Terraform Plan (${env})`)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Upload Plan
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ env.TF_ENVIRONMENT }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan
          retention-days: 1

  apply:
    name: Terraform Apply (${{ github.event.inputs.environment || 'dev' }})
    needs: plan
    if: |
      needs.plan.outputs.has_changes == 'true' &&
      (github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    permissions:
      id-token: write
      contents: read

    env:
      TF_VAR_anthropic_api_key: ${{ secrets.TF_VAR_ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14"

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Select Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform workspace select ${{ env.TF_ENVIRONMENT }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ env.TF_ENVIRONMENT }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve tfplan
