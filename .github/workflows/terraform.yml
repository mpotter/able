name: Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to plan/apply'
        required: true
        default: 'dev'
        type: choice
        options:
          - global
          - dev
          - prod

env:
  AWS_REGION: us-east-1
  TF_VERSION: "1.14"

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      global: ${{ steps.changes.outputs.global }}
      dev: ${{ steps.changes.outputs.dev }}
      prod: ${{ steps.changes.outputs.prod }}
      modules: ${{ steps.changes.outputs.modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - only run specified target
            echo "global=${{ github.event.inputs.target == 'global' }}" >> $GITHUB_OUTPUT
            echo "dev=${{ github.event.inputs.target == 'dev' }}" >> $GITHUB_OUTPUT
            echo "prod=${{ github.event.inputs.target == 'prod' }}" >> $GITHUB_OUTPUT
            echo "modules=false" >> $GITHUB_OUTPUT
          else
            # Check for changes in each directory
            GLOBAL_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -q "^infra/terraform/global/" && echo "true" || echo "false")
            DEV_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -q "^infra/terraform/environments/dev/" && echo "true" || echo "false")
            PROD_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -q "^infra/terraform/environments/prod/" && echo "true" || echo "false")
            MODULES_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -q "^infra/terraform/modules/" && echo "true" || echo "false")

            echo "global=$GLOBAL_CHANGED" >> $GITHUB_OUTPUT
            echo "dev=$DEV_CHANGED" >> $GITHUB_OUTPUT
            echo "prod=$PROD_CHANGED" >> $GITHUB_OUTPUT
            echo "modules=$MODULES_CHANGED" >> $GITHUB_OUTPUT

            echo "Changes detected:"
            echo "  global: $GLOBAL_CHANGED"
            echo "  dev: $DEV_CHANGED"
            echo "  prod: $PROD_CHANGED"
            echo "  modules: $MODULES_CHANGED"
          fi

  global:
    name: Global Infrastructure
    needs: detect-changes
    if: needs.detect-changes.outputs.global == 'true'
    runs-on: ubuntu-latest
    environment: global

    permissions:
      id-token: write
      contents: read
      pull-requests: write
      actions: write
      administration: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_VAR_budget_alert_email: ${{ vars.ALARM_EMAIL }}

    defaults:
      run:
        working-directory: infra/terraform/global

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        shell: bash {0}
        run: |
          terraform plan \
            -detailed-exitcode \
            -out=tfplan \
            -no-color > plan_output.txt 2>&1
          EXIT_CODE=$?
          cat plan_output.txt
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check Plan Result
        if: steps.plan.outputs.exit_code == '1'
        run: exit 1

      - name: Terraform Apply
        if: |
          github.event_name != 'pull_request' &&
          steps.plan.outputs.exit_code == '2'
        run: terraform apply -auto-approve tfplan

  dev:
    name: Dev Environment
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.dev == 'true' ||
      needs.detect-changes.outputs.modules == 'true'
    runs-on: ubuntu-latest
    environment: dev

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    env:
      TF_VAR_anthropic_api_key: ${{ secrets.TF_VAR_ANTHROPIC_API_KEY }}
      TF_VAR_alarm_email: ${{ vars.ALARM_EMAIL }}

    defaults:
      run:
        working-directory: infra/terraform/environments/dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        shell: bash {0}
        run: |
          terraform plan \
            -detailed-exitcode \
            -out=tfplan \
            -no-color > plan_output.txt 2>&1
          EXIT_CODE=$?
          cat plan_output.txt
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check Plan Result
        if: steps.plan.outputs.exit_code == '1'
        run: exit 1

      - name: Terraform Apply
        if: |
          github.event_name != 'pull_request' &&
          steps.plan.outputs.exit_code == '2'
        run: terraform apply -auto-approve tfplan

  prod:
    name: Prod Environment
    needs: [detect-changes, dev]
    if: |
      always() &&
      (needs.detect-changes.outputs.prod == 'true' ||
       needs.detect-changes.outputs.modules == 'true') &&
      (needs.dev.result == 'success' || needs.dev.result == 'skipped')
    runs-on: ubuntu-latest
    environment: prod

    permissions:
      id-token: write
      contents: read
      pull-requests: write

    env:
      TF_VAR_anthropic_api_key: ${{ secrets.TF_VAR_ANTHROPIC_API_KEY }}
      TF_VAR_alarm_email: ${{ vars.ALARM_EMAIL }}

    defaults:
      run:
        working-directory: infra/terraform/environments/prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        shell: bash {0}
        run: |
          terraform plan \
            -detailed-exitcode \
            -out=tfplan \
            -no-color > plan_output.txt 2>&1
          EXIT_CODE=$?
          cat plan_output.txt
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check Plan Result
        if: steps.plan.outputs.exit_code == '1'
        run: exit 1

      - name: Terraform Apply
        if: |
          github.event_name != 'pull_request' &&
          steps.plan.outputs.exit_code == '2'
        run: terraform apply -auto-approve tfplan
